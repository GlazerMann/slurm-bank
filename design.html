<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>design</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="style.css" type="text/css" />

<link rel="stylesheet" href="local.css" type="text/css" />










</head>
<body>

<div class="page">

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">

<a href="./index.html">slurm-bank</a>/ 

</span>
<span class="title">
design

</span>
</span>



</div>









</div>





<div id="pagebody">

<div id="content" role="main">
<h2>DESIGN</h2>

<p>Based on discussions from</p>

<ul>
<li><a href="http://groups.google.com/group/slurm-devel/browse_frm/thread/1c8805fb274c108f#">http://groups.google.com/group/slurm-devel/browse_frm/thread/1c8805fb274c108f#</a></li>
<li><a href="http://groups.google.com/group/slurm-devel/browse_thread/thread/b06f3985cc7504b2?tvc=2">http://groups.google.com/group/slurm-devel/browse_thread/thread/b06f3985cc7504b2?tvc=2</a></li>
</ul>


<h2>Requirements</h2>

<p>This documentation assumes the user knows basic slurm administration.</p>

<p>Slurmdbd must be configured and working, account enforcing is enabled
in <em>slurm.conf</em></p>

<pre><code>AccountingStorageEnforce=limits
</code></pre>

<p>Note that the <em>PriorityDecayHalfLife</em> and <em>PriorityUsageResetPeriod</em> can
be used to allow usage half-life decay and reset. This is because
the usage information is pulled directly from the Slurmdbd via
<em>sreport</em>; whereas the two parameters above only affect the way
usage is stored in local *_usage files.</p>

<p>Note also that when the scheduler looks to see if an association has
sufficient balance to start a new job, it compares the "GrpCPUMins"
field against the local *_usage files to check if enough time is
available (not the Slurmdbd), this can result in negative balances
being reported by "sbank balance statement".</p>

<p>What is also required is a pretty good estimate of the total available
cpu hours that you have on your cluster that you can allocate to
accounts.</p>

<p>Users will need to learn how to use accounts (nothing new here).</p>

<p>sacctmgr and sreport are required and must be working.</p>

<p>One implementation detail is that 'sreport' requires a start date
parameter (otherwise it defaults to the previous day). The script defaults
to using a start date of 3 years in the past. This can be changed with
the '-s yyyy-mm-dd' parameter.</p>

<h2>How it works</h2>

<p>Time is deposited to an account, which gets drawn from whenever a job
is submitted to the cluster. Currently the "GrpCPUMins" is used.</p>

<p>Note that there is no concept of 'Reserved' time, like Gold does. This
is probably a good thing - as the Gold way of doing it sometimes leads
to Reserved time getting stuck, and never released. The Slurm way seems
to only subtract time when the jobs are actually running.</p>

<p>A consequence of this is that it will kill jobs mid-run (say if another
user in the Account uses up all the time first) - again, probably not
a bad thing.</p>

<h3>Time period</h3>

<p>The tools work with hours as the time unit (conversions are done where
needed).</p>

<h3>The slurmdbd hierachy</h3>

<p>We assume this type of setup, which is the default behaviour of the
slurmdbd. (This is our current assumption to keep things simple)</p>

<ul>
<li>root 20N hours available

<ul>
<li>account1 with 1N hours</li>
<li>account2 with 1N hours</li>
<li>account3 with 2N hours</li>
<li>account4 with 2N hours</li>
</ul>
</li>
</ul>


<p>There is effectively no hierachy at all, we could do something like this...</p>

<ul>
<li>root with 20U of time

<ul>
<li>CLASS-A with 1U time

<ul>
<li>account1</li>
<li>account2</li>
</ul>
</li>
<li>CLASS-B with 0.5U time

<ul>
<li>account3</li>
</ul>
</li>
<li>CLASS-C with 0.25U time

<ul>
<li>account4</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>We would have to add some checks or script up the <a href="./sbank-project.html">sbank-project</a>
wrapper to work in a pre-defined way to allow for the different
workflows.</p>

<h3>Note</h3>

<p>It <em>seems</em> that the slurmctld must be restarted sometimes - for new
Accounts or Account updates. This needs to be checked more (it may not
be the case).</p>

<h2>Missing components</h2>

<ul>
<li>Ability to <em>end</em> accounts at a given date, could associate accounts
with overlapping reservations. We tried this but we can't set a
<em>maint</em> reservation that is honoured by slurm. So this is a no go
for now. One idea is to do it with an external database and some
helper scripts (done via crontab or something similar).

<ul>
<li>Note that setting GrpCPUMins to 0 can be used to do this - to put
an end on the account.</li>
<li>One idea is to do this offline with an external database and a
handful of scripts.</li>
<li>Another idea is to use a flat text file with KEY, PROJECTNAME,
STARTDATE, ENDDATE and STATUS columns, we could then loop
through this file every day and simply expire accounts as
needed. <a href="http://www.gnu.org/software/recutils/">gnu-recutils</a> looks like a good set of tools for
manipulating a flatfile based database. We could dump out a
recutils styled db with a perl script every night, then run our
own expiration script. On second thought sqlite3 might be a better choice.</li>
</ul>
</li>
<li>This was mainly conceived as a Gold (bank) replacement, if we ditch maui,
what other functionality will users miss? Have a 'showq' and 'checkjob'
wrapper?</li>
</ul>


<h4>recutils as a database backend</h4>

<p>Possibly define this type of record</p>

<pre><code>%rec: project
%mandatory: project createdate
%type: project line
%type: startdate date
%type: enddate date
%type: createdate date
%type: status enum active inactive
%type: id int
%key: id
%auto: id createdate

id: 0
modifydate: Thu, 26 May 2011 14:46:14 +0100
project: physics
enddate: 2009-06-06
status: active

id: 1
modifydate: Thu, 26 May 2011 14:49:01 +0100
project: chemistry
enddate: 2011-06-06
status: inactive

id: 2
modifydate: Thu, 26 May 2011 14:49:42 +0100
project: maths
enddate: 2012-06-06
status: active
</code></pre>

<p>To insert a record</p>

<pre><code>$ recins -t project -f project -v chemistry \
    -f enddate -v 2011-06-06 \
    projects.rec
$ recins -t project -f project -v physics \
    -f enddate -v "2012-06-06" \
    projects.rec
</code></pre>

<p>To select records after whose accounts are to expire</p>

<pre><code>$ recsel -t project -e "enddate &gt;&gt; '2011-07-01'" projects.rec
</code></pre>

<p>Or for a machine readable form</p>

<pre><code>$ recsel -C -R project -t project \
    -e "enddate &lt;&lt; '2012-07-01'" projects.rec
</code></pre>

<p>Return a list of projects that are 'active' after an 'enddate'</p>

<pre><code>$ recsel -C -R project -t project \
    -e "enddate &lt;&lt; '2012-07-01'" -e "status='active'" projects.rec
</code></pre>

<p>With this list of codes we should be able to mark projects with sbank
with no more runnable hours. A tool or script to do the above probably
should be kept seperate from the main set of scripts.</p>

<h3>Done</h3>

<ul>
<li>Helper script to add/remove hours from a given account (short of
manually doing it by hand and doing the sums). (This is somewhat
done as <a href="./sbank-deposit.html">sbank-deposit</a>)</li>
<li>And to add/remove users from an Account. (see below with gchproject
idea). <a href="./sbank-project.html">sbank-project</a></li>
<li>some additional commands/wrapper scripts to mimic GOLD</li>
<li>wrapper script for creating accounts (gmkproject like command),
default behaviour should create accounts associated with a default
root account and allow the user to define a parent account if
necessary. Need to define how projects should be created deleted,
do you want a structure/hierachy in the accounting db?
<a href="./sbank-project.html">sbank-project</a></li>
<li>wrapper script for adding/deleting users from (gchproject like
command) <a href="./sbank-user.html">sbank-user</a> or <a href="./sbank-project.html">sbank-project</a></li>
<li>wrapper script for making users (gmkuser), do we need to create
users in slurmdbd before associating users with
projects/accounts. <a href="./sbank-user.html">sbank-user</a></li>
</ul>


<h2>TODO for the script(s)</h2>

<ul>
<li>Re-write using Slurm-Perl API (or in C).</li>
<li>A bunch of basic tests (partially done), need to be more systematic.</li>
</ul>


<h2>Ideas</h2>

<ul>
<li><p><a href="./sbank-submit.html">sbank-submit</a> to wrap up submitting jobs to a cluster, this could
be used to hide quite a few commands from the user. Or else we could
place some of the scripts/sbank commands into the epilog/prologue.</p></li>
<li><p>Reservations according to
https://computing.llnl.gov/linux/slurm/reservations.html implies
that users will be charged if they do not use their reservation.
We should define that only accounts get associated with reservations,
if possible we should figure out how to penalise users for the
time reserved (i.e. interest rates).</p></li>
<li><p><a href="./sbank-refund.html">sbank-refund</a> given a job ID, go through slurmdbd logs and figure
out the hours used, account used and refund the hours back to the
user. sacct -j JOBID has the elapsed time in a slurm time
string. Should the transaction logs be checked so users don't get
multiple refunds?</p></li>
</ul>


<h3>Implemented Ideas</h3>

<ul>
<li>Feedback for user, e.g. on submission estimate how many hours are
needed then print a number of hours that is in the balance before and
after the job has run. Maybe add this in the form of <em>sbank balance
request --nodes N --cores C --time hours --account ACCOUNT</em> <a href="./sbank-balance.html">sbank-balance</a></li>
<li>the balance request commands - use 'sbank cluster' to find the local
cluster, if -c is not specified <a href="./sbank-cluster.html">sbank-cluster</a></li>
<li>similarly, it would be nice to add a command to 'sbank user' to list the
current user's default account on the cluster. I noticed that people might
leave out the account name in their job script, and so slurm will just
use their default one. <a href="./sbank-user.html">sbank-user</a></li>
<li><p>for 'sbank balance request', the verbose flag prints out the following:</p>

<p>  Current balance     = nnn
  Requested CPU hours = nnn
  Expected balance    = nnn</p></li>
<li><p>I'd like 'user list' to maybe default to the current user, on the local
cluster, and print their default account ? Not sure if the current behaviour
of showing all users is the best. It could be specified with '-a' or something <a href="./sbank-user.html">sbank-user</a></p></li>
<li>sbank starts with a basic sanity checking script, seeing if commands like
'sacctmgr' are actually there? If it's packaged as an rpm, the dependencies
will catch this, but it's no harm to have it. <span class="createlink">sbank-common</span></li>
<li>Simple <a href="./tests.html">tests</a> to make sure things are working</li>
</ul>


<h2>Tested on</h2>

<ul>
<li>SLURM 2.2.0</li>
<li>SL5x (and system version of perl/bash)</li>
</ul>


</div>





<div id="comments" role="complementary">




<div class="addcomment">Comments on this page are closed.</div>

</div>



</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">






<div id="backlinks">
Links:

<a href="./index.html">index</a>


</div>






<div class="pagedate">
Last edited <span class="date">Fri 26 Oct 05:12:33 2018</span>
<!-- Created <span class="date">Sat 16 Jul 11:35:03 2016</span> -->
</div>

</div>


<!-- from slurm-bank -->
</div>

</div>

</body>
</html>
